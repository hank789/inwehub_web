<template>
  <div>
    <div class="message">
      <div class="message_title">
        <p>留言</p>
        <svg class="icon" aria-hidden="true" @tap.stop.prevent="comment(0, '', list)">
          <use xlink:href="#icon-xiugai"></use>
        </svg>
        <i class="bot"></i>
      </div>

      <div class="listWrapper empty" v-show="list.length === 0">
        <svg class="icon" aria-hidden="true">
          <use xlink:href="#icon-zanwushuju"></use>
        </svg>
        <p>暂无留言</p>
      </div>

      <div class="listWrapper" v-show="list.length !== 0 && showList">
        <div v-infinite-scroll="loadMore" infinite-scroll-disabled="busy" infinite-scroll-distance="10">
          <ul class="message_detail">
            <li v-for="(item, index) in list" @tap.stop.prevent="clickComment(item, list)" :key="index">
              <div class="message_t">
                <p @tap.stop.prevent="toResume(item.owner.uuid)">
                  <img :src="item.owner.avatar"/>
                  <svg class="icon" aria-hidden="true" v-show="item.owner.is_expert">
                    <use xlink:href="#icon-zhuanjiabiaojishixin"></use>
                  </svg>
                </p>
                <p class="mui-ellipsis">{{ item.owner.name }}</p>
                <p>{{ item.created_at.replace(/-/g, '/') }}</p>
              </div>
              <div id='message_b' class="message_b textToLink" v-html="textToLink(item.content)"></div>

              <DiscussReplay
                v-if="item.children.length"
                :children="item.children"
                :parentOwnerName="item.owner.name"
                :isShow="!!item.moreReply"
                @comment="clickComment"
              ></DiscussReplay>

              <div class="text-13-03aef9 moreReply" @tap.stop.prevent="moreReply(item)" v-if="item.children.length>2 && !item.moreReply">查看全部{{item.children.length}}条回复</div>

              <!--<i class="bot" v-show="list.length-1 !== index"></i>-->
            </li>
          </ul>
        </div>
      </div>
    </div>

    <div id="sheet1" class="mui-popover mui-popover-bottom mui-popover-action">
      <!-- 可选择菜单 -->
      <ul class="mui-table-view">
        <li class="mui-table-view-cell">
          <a @tap.stop.prevent="doDelComment">删除我的回复</a>
        </li>
      </ul>
      <!-- 取消菜单 -->
      <ul class="mui-table-view">
        <li class="mui-table-view-cell">
          <a @tap.stop.prevent="hideDelComment"><b>取消</b></a>
        </li>
      </ul>
    </div>

  </div>
</template>

<script>
  import { postRequest } from '../../utils/request'
  import { getLocalUserInfo } from '../../utils/user'
  import { getIndexByIdArray } from '../../utils/array'
  import Vue from 'vue'
  import DiscussReplay from '../../components/discover/DiscussReply.vue'
  import { textToLinkHtml } from '../../utils/dom'
  import { openVendorUrl, openAppUrl } from '../../utils/plus'
  import userAbility from '../../utils/userAbility'

  const Discuss = {
    data: () => ({
      loading: true,
      busy: false,
      showList: true,
      commentTarget: null,
      delCommentId: 0,
      delList: null,
      page: 1,
      list: []
    }),
    props: {
      listApi: {
        type: String,
        default: ''
      },
      listParams: {
        type: Object,
        default: () => {
          return null
        }
      },
      storeApi: {
        type: String,
        default: ''
      },
      storeParams: {
        type: Object,
        default: () => {
          return null
        }
      }
    },
    mounted () {
    },
    components: {
      DiscussReplay
    },
    computed: {},
    methods: {
      rootComment () {
        this.comment(0, '', this.list)
      },
      clickComment (comment, list) {
        var commentUid = comment.owner.uuid
        var userInfo = getLocalUserInfo()
        var uuid = userInfo.uuid
        if (commentUid === uuid) {
          this.delComment(comment, list)
        } else {
          this.comment(comment.id, comment.owner.name, list)
        }
      },
      doDelComment () {
        postRequest('article/destroy-comment', {
          id: this.delCommentId
        }).then(response => {
          var code = response.data.code
          if (code !== 1000) {
            window.mui.toast(response.data.message)
            return
          }
          var index = getIndexByIdArray(this.delList, this.delCommentId)
          if (index) {
            this.delList = this.delList.splice(index, 1)
          }
          this.hideDelComment()
          this.$emit('delCommentSuccess')
        })
      },
      hideDelComment () {
        var del = document.getElementById('sheet_comment_del')
        if (del) {
          window.mui('#sheet_comment_del').popover('hide')
        }
      },
      delComment (comment, list) {
        this.delCommentId = comment.id
        this.delList = list
        var del = document.getElementById('sheet_comment_del')
        if (del) {
          window.mui('#sheet_comment_del').popover('toggle')
        } else {
          var ele = document.getElementById('sheet1')
          ele.id = 'sheet_comment_del'
          document.body.appendChild(ele)
          setTimeout(() => {
            window.mui('#sheet_comment_del').popover('toggle')
          }, 100)
        }
      },
      textToLink (text) {
        return textToLinkHtml(text)
      },
      moreReply (item) {
        item.moreReply = 1
        var indexOfItem = getIndexByIdArray(this.list, item.id)
        Vue.set(this.list, indexOfItem, item)
      },
      toResume (uuid) {
        if (!uuid) {
          return false
        }
        this.$router.pushPlus('/share/resume?id=' + uuid + '&goback=1' + '&time=' + (new Date().getTime()))
      },
      resetList () {
        this.page = 1
        this.list = []
        this.getList()
      },
      comment (parentId, commentTargetUsername, list) {
        var commentTarget = {
          parentId: parentId || 0,
          commentTargetUsername: commentTargetUsername || '',
          list: list
        }

        var data = {
          targetUsername: commentTargetUsername || '',
          commentData: commentTarget
        }

        console.log('回复 data:' + JSON.stringify(data))

        this.$emit('comment', data)
      },
      sendMessage (message) {
        this.commentTarget = message.commentData
        var parentId = this.commentTarget.parentId
        var params = Object.assign({
          body: message.content,
          content: message.content,
          parent_id: parentId,
          mentions: message.noticeUsers
        }, this.storeParams)

        postRequest(this.storeApi, params).then(response => {
          var code = response.data.code

          if (code === 6108) {
            userAbility.alertGroups(this.$parent, response.data.data.group_id)
            return
          }

          if (code !== 1000) {
            window.mui.alert(response.data.message)
            return
          }

          var data = response.data.data

          window.mui.toast(response.data.message)

          this.prependItem(
            data.id,
            message.content,
            data.created_at,
            parentId
          )

          this.$emit('commentFinish')
        })
      },
      prependItem (id, msg, createdAt, parentId) {
        var userInfo = getLocalUserInfo()
        var item = {
          id,
          children: [],
          content: msg,
          owner: {
            is_expert: userInfo.is_expert,
            avatar: userInfo.avatar_url,
            user_id: userInfo.user_id,
            uuid: userInfo.uuid,
            name: userInfo.name
          },
          created_at: createdAt
        }
        console.log('discuss:item:' + JSON.stringify(item))

        console.log('discuss:parentid:' + parentId)
        if (parentId) {
          var parentIndex = getIndexByIdArray(this.commentTarget.list, parentId)
          console.log('discuss:parentIndex:' + parentIndex)
          if (parentIndex > 0) {
            if (this.commentTarget.list[parentIndex].children) {
              this.commentTarget.list[parentIndex].children.unshift(item)
            } else {
              this.commentTarget.list[parentIndex].children = [item]
            }
          } else {
            this.resetList()
          }
        } else {
          console.log('discuss:commentTarget:' + JSON.stringify(this.commentTarget))
          if (this.commentTarget.list) {
            this.commentTarget.list.unshift(item)
          } else {
            this.resetList()
          }
        }
      },
      loadMore () {
        this.busy = true
        console.log('loadMore')
        if (JSON.stringify(this.listParams) === '{}') {
          return
        }
        this.getList()
      },
      getList () {
        if (!this.listParams) {
          return false
        }
        var params = Object.assign({page: this.page}, this.listParams)
        postRequest(this.listApi, params).then(response => {
          var code = response.data.code
          if (code !== 1000) {
            window.mui.alert(response.data.message)
            return
          }

          if (response.data.data.data.length > 0) {
            this.list = this.list.concat(response.data.data.data)
          }

          if (response.data.data.data.length < 10) {
            this.busy = true
          } else {
            this.busy = false
          }

          this.page++

          this.loading = 0
        })
      }
    },
    watch: {
      'listParams' (newVal, oldVal) {
        if (JSON.stringify(newVal) !== JSON.stringify(oldVal)) {
          this.resetList()
        }
      }
    },
    created () {

    },
    updated () {
      this.$nextTick(() => {
        var eles = this.$el.querySelectorAll('.textToLink')
        for (var i in eles) {
          openVendorUrl(eles[i])
          openAppUrl(eles[i])
        }
      })
    }
  }
  export default Discuss
</script>

<style scoped="scoped">
  div,
  span,
  p,
  ul,
  li,
  i,
  a {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .bot {
    position: absolute;
    right: 0;
    bottom: 0;
    left: 0rem;
    height: 0.026rem;
    -webkit-transform: scaleY(.5);
    transform: scaleY(.5);
    background-color: rgb(220, 220, 220);
  }

  .message {
    width: 100%;
    background: #FFFFFF;
    overflow: hidden;
    padding: 0 0.4rem 0.4rem 0.4rem;
  }

  .message_title {
    width: 100%;
    height: 1.173rem;
    position: relative;
    line-height: 1.173rem;

  }

  .message_title p {
    float: left;
    font-size: 0.426rem;
    color: #444444;

  }

  .message_title svg {
    float: right;
    font-size: 0.506rem;
    color: #03aef9;
    margin-top: 0.32rem;
  }

  .message_detail {
    width: 100%;
    overflow: hidden;
  }

  .message_detail li {
    width: 100%;
    overflow: hidden;
    position: relative;
    padding: 0.32rem 0 0.32rem 0;
    border-bottom: 0.026rem solid #dcdcdc;
  }
  .message_detail li:nth-last-of-type(1){
    padding: 0.32rem 0 0 0;
    border-bottom: none;
  }

  .message_b {
    font-size: 0.373rem;
    color: #444444;
    margin-top: 0.186rem;
  }

  .message_t {
    width: 100%;
    height: 0.853rem;
  }

  .message_t p:nth-child(1) {
    width: 0.853rem;
    height: 0.853rem;
    float: left;
    position: relative;
  }

  .message_t p:nth-child(1) img {
    width: 0.853rem;
    height: 0.853rem;
    border-radius: 50%;
  }

  .message_t p:nth-child(1) svg {
    font-size: 0.426rem;
    color: #03aef9;
    position: absolute;
    bottom: 0;
    right: -0.133rem;
  }

  .message_t p:nth-child(2) {
    float: left;
    margin-left: 0.266rem;
    height: 0.853rem;
    line-height: 0.853rem;
  }

  .message_t p:nth-child(3) {
    float: right;
    height:100%;
    line-height: 0.853rem;
    font-size: 0.346rem;
    color: #c8c8c8;
  }

  .message_t p:nth-child(2) span:nth-child(2) {
    color: #c8c8c8;
  }

  .listWrapper {
  }

  .commentWrapper {
    background: #ececee;
    position: fixed;
    width: 100%;
    bottom: 0;
    left: 0;
    min-height: 1.2rem;
    overflow: hidden;
    padding: 0.133rem 0.4rem;
    z-index: 77;
  }

  .commentWrapper .textareaWrapper {
    position: relative;
    background: #fff;
    border-radius: 0.133rem;
    min-height: 0.933rem;
  }

  .commentWrapper textarea {
    border: none;
    display: inline-block;
    width: 100%;
    height: 0.533rem;
    margin: 0.16rem 0 0;
    padding: 0 0.826rem 0 0.133rem;
    font-size: 0.373rem;

  }

  .commentWrapper textarea::placeholder {
    color: #c8c8c8;
  }

  .commentWrapper .icon {
    position: absolute;
    right: 0.133rem;
    color: #03aef9;
    font-size: 0.693rem;
    bottom: 0.133rem;
  }

  .empty {

  }

  .empty {
    width: 100%;
    background: #FFFFFF;
    margin-bottom: 0.266rem;
    text-align: center;
    padding: 0.533rem 0;
  }

  .empty .icon {
    font-size: 1.333rem;
  }

  .empty p {
    width: 100%;
    font-size: 0.32rem;
    color: #c8c8c8;
    text-align: center;
  }

  .component-comment-reply{
    margin-top:0.133rem;
  }

  .moreReply{
    margin-top:0.133rem;
  }

  #sheet_comment_del li {
    color:#4990E2 !important;
    padding:0.346rem 0.4rem;
  }
</style>
